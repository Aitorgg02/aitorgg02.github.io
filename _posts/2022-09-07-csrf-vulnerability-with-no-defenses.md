---
layout: single
title: CSRF vulnerability with no defenses – PortSwigger Write Up
excerpt: "En este post vamos a estar resolviendo el laboratorio de PortSwigger: “CSRF vulnerability with no defenses."
date: 2022-09-07
classes: wide
#header:
#  teaser: /assets/images/portswigger/stored_xss_into_html_context_with_nothing_encoded/portada.png
#  teaser_home_page: true
categories:
  - Portswigger
tags:
  - Burpsuite
  - JavaScript
  - CSRF
  - Apprentice
---

En este post vamos a estar resolviendo el laboratorio de PortSwigger: "CSRF vulnerability with no defenses."

<p align="center">
     <img src="/assets/images/portswigger/csrf_vulnerability_with_no_defenses/1.png" width="1000">
</p><br>

En este caso, el laboratorio nos indica que hay un CSRF en la funcionalidad de cambio de email. Para resolver el laboratorio, debemos crear una página HTML que se aproveche del CSRF para cambiar el email de quien visite nuestra web. Por último, se nos proporciona unas credenciales para acceder a una cuenta.

Sabiendo todo esto, iniciamos el laboratorio y nos dirigimos a “My account” para iniciar sesión:

<p align="center">
     <img src="/assets/images/portswigger/csrf_vulnerability_with_no_defenses/2.png" width="1000">
</p><br>


<p align="center">
     <img src="/assets/images/portswigger/csrf_vulnerability_with_no_defenses/3.png" width="1000">
</p><br>


Una vez hemos iniciado sesión, se nos redirige por así decirlo a nuestro perfil:

<p align="center">
     <img src="/assets/images/portswigger/csrf_vulnerability_with_no_defenses/4.png" width="1000">
</p><br>

Aquí, como mencionaba el enunciado, encontramos una funcionalidad para cambiar el email de nuestra cuenta, por lo que preparamos el burp suite para interceptar la petición del cambio:

<p align="center">
     <img src="/assets/images/portswigger/csrf_vulnerability_with_no_defenses/5.png" width="1000">
</p><br>

Con el burp suite preparado, colocamos un email aleatorio y le damos a “Update email”:

<p align="center">
     <img src="/assets/images/portswigger/csrf_vulnerability_with_no_defenses/6.png" width="1000">
</p><br>

Al momento de darle, burp suite recibe la petición:

<p align="center">
     <img src="/assets/images/portswigger/csrf_vulnerability_with_no_defenses/7.png" width="1000">
</p><br>

Y como podemos observar, el único parámetro que se envía en el cuerpo de la petición es “email”. No hay ningún parámetro más cuyo valor sea aleatorio e imposible de predecir, por lo que es posible crear una plantilla maliciosa que cree una petición como la que se puede ver arriba, teniendo en cuenta, que las cookies de un sitio son incluidas en cualquier petición que el navegador haga a ese sitio.

Si dejamos que esta petición se envíe, el email cambiará sin problemas:

<p align="center">
     <img src="/assets/images/portswigger/csrf_vulnerability_with_no_defenses/8.png" width="1000">
</p><br>

Ya sabemos toda la información necesaria y todo funciona como se espera, por lo que desactivamos el proxy y nos dirigimos al servidor del exploit:

<p align="center">
     <img src="/assets/images/portswigger/csrf_vulnerability_with_no_defenses/9.png" width="1000">
</p><br>

Una vez dentro tenemos los siguientes campos:

<p align="center">
     <img src="/assets/images/portswigger/csrf_vulnerability_with_no_defenses/10.png" width="1000">
</p><br>


Es aquí donde creamos la plantilla HTML maliciosa que generará la petición que veíamos arriba cuando la víctima visite la página:

<p align="center">
     <img src="/assets/images/portswigger/csrf_vulnerability_with_no_defenses/11.png" width="1000">
</p><br>


Sí, le damos a ver exploit. nosotros mismos visitaremos la página maliciosa.

Como tenemos la sesión guardada en el navegador con las cookies, al visitarla, la petición se genera correctamente y el email es cambiado, todo a partir de solo visitar la web maliciosa.

Entonces, lo que ha ocurrido es:

* La web maliciosa genera una petición especialmente diseñada cuando se visita.
* Si el usuario está logueado en la web vulnerable (este caso), el navegador incluirá automáticamente la cookie de sesión en la petición (suponiendo que la el atributo SameSite de la cookie no está habilitado, que no es este caso)
* La web maliciosa procesará la petición, ya que es imposible diferenciar si la ha hecho la propio víctima o no, por lo que la procesará sin problemas y se cambiará la dirección de email.
Como hemos observado que el exploit funciona perfectamente, simplemente podemos enviarlo a la víctima:

Y de esta manera, resolvemos el laboratorio:


<p align="center">
     <img src="/assets/images/portswigger/csrf_vulnerability_with_no_defenses/12.png" width="1000">
</p><br>

<p align="center">
     <img src="/assets/images/portswigger/csrf_vulnerability_with_no_defenses/13.png" width="1000">
</p><br>

¡Un saludo y espero que os sirva de apoyo!
